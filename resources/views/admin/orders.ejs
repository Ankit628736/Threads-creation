<section class="orders light-section">
    <div class="container mx-auto pt-12">
        <!-- Admin Navigation -->
        <div class="mb-6 bg-white rounded-lg shadow p-4">
            <nav class="flex space-x-6">
                <a href="/admin/orders" class="text-blue-600 font-semibold border-b-2 border-blue-600">Orders</a>
                <a href="/admin/menu" class="text-gray-600 hover:text-blue-600">Menu</a>
                <a href="/admin/users" class="text-gray-600 hover:text-blue-600">Users</a>
                <a href="/" class="text-gray-600 hover:text-blue-600">Home</a>
            </nav>
        </div>
        
        <h1 class="font-bold text-lg mb-4">All orders (<%= orders ? orders.length : 0 %>)</h1>
        
        <% if (typeof error !== 'undefined') { %>
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <%= error %>
            </div>
        <% } %>
        
        <% if (!orders || orders.length === 0) { %>
            <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4">
                <h3 class="font-bold">No orders found</h3>
                <p>There are currently no customer orders in the system.</p>
                <p class="mt-2">Orders will appear here once customers place them.</p>
            </div>
        <% } else { %>
            <table class="w-full table-auto bg-white shadow rounded">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold">Order Items</th>
                        <th class="px-4 py-3 text-left font-semibold">Customer</th>
                        <th class="px-4 py-3 text-left font-semibold">Address</th>
                        <th class="px-4 py-3 text-left font-semibold">Phone</th>
                        <th class="px-4 py-3 text-left font-semibold">Status</th>
                        <th class="px-4 py-3 text-left font-semibold">Total</th>
                        <th class="px-4 py-3 text-left font-semibold">Placed at</th>
                        <th class="px-4 py-3 text-left font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <% orders.forEach(order => { %>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-3">
                                <div class="max-w-xs">
                                    <% 
                                    let itemsArray = [];
                                    if (order.items) {
                                        if (Array.isArray(order.items)) {
                                            itemsArray = order.items;
                                        } else {
                                            // Convert object to array
                                            itemsArray = Object.values(order.items);
                                        }
                                    }
                                    %>
                                    <% if (itemsArray.length > 0) { %>
                                        <% itemsArray.forEach((item, index) => { %>
                                            <div class="<%= index > 0 ? 'mt-1' : '' %>">
                                                <span class="font-medium"><%= item.item ? item.item.name : (item.name || 'Unknown Item') %></span>
                                                <span class="text-gray-600">x<%= item.qty %></span>
                                                <span class="text-sm text-gray-500">(₹<%= item.item ? item.item.price : (item.price || 0) %>)</span>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <span class="text-gray-500">No items</span>
                                    <% } %>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="font-medium"><%= order.customerId ? order.customerId.name : 'Unknown' %></div>
                                <div class="text-sm text-gray-600"><%= order.customerId ? order.customerId.email : 'N/A' %></div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="max-w-xs text-sm">
                                    <%= order.address || 'Not provided' %>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <%= order.phone || 'Not provided' %>
                            </td>
                            <td class="px-4 py-3">
                                <select class="status-select px-2 py-1 rounded border
                                    <%= order.status === 'confirmed' ? 'bg-blue-100 text-blue-800' : 
                                        order.status === 'prepared' ? 'bg-yellow-100 text-yellow-800' : 
                                        order.status === 'delivered' ? 'bg-green-100 text-green-800' : 
                                        order.status === 'completed' ? 'bg-gray-100 text-gray-800' : 
                                        'bg-orange-100 text-orange-800' %>"
                                    data-order-id="<%= order._id %>">
                                    <option value="order_placed" <%= order.status === 'order_placed' ? 'selected' : '' %>>Order Placed</option>
                                    <option value="confirmed" <%= order.status === 'confirmed' ? 'selected' : '' %>>Confirmed</option>
                                    <option value="prepared" <%= order.status === 'prepared' ? 'selected' : '' %>>Prepared</option>
                                    <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                                    <option value="completed" <%= order.status === 'completed' ? 'selected' : '' %>>Completed</option>
                                </select>
                            </td>
                            <td class="px-4 py-3 font-semibold">
                                <%
                                let totalAmount = 0;
                                if (order.items) {
                                    if (Array.isArray(order.items)) {
                                        totalAmount = order.items.reduce((total, item) => total + (item.qty * (item.item ? item.item.price : item.price || 0)), 0);
                                    } else {
                                        // Handle object format
                                        Object.values(order.items).forEach(item => {
                                            totalAmount += (item.qty * (item.item ? item.item.price : item.price || 0));
                                        });
                                    }
                                }
                                %>
                                ₹<%= totalAmount %>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <%= moment ? moment(order.createdAt).format('MMM DD, YYYY HH:mm') : new Date(order.createdAt).toLocaleString() %>
                            </td>
                            <td class="px-4 py-3">
                                <button class="update-status bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600"
                                        data-order-id="<%= order._id %>">
                                    Update
                                </button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle status updates
    const updateButtons = document.querySelectorAll('.update-status');
    
    updateButtons.forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            const statusSelect = document.querySelector(`select[data-order-id="${orderId}"]`);
            const newStatus = statusSelect.value;
            
            // Send update request
            fetch('/admin/orders/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    orderId: orderId,
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    showMessage('Order status updated successfully!', 'success');
                } else {
                    showMessage('Failed to update order status', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error updating order status', 'error');
            });
        });
    });
    
    function showMessage(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `fixed top-4 right-4 px-4 py-3 rounded z-50 ${
            type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' : 
            'bg-red-100 border border-red-400 text-red-700'
        }`;
        alertDiv.textContent = message;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            document.body.removeChild(alertDiv);
        }, 3000);
    }
});
</script>